<?xml version="1.0" standalone="no"?>

<!DOCTYPE caldavtest SYSTEM "caldavtest.dtd">

<!--
 Copyright (c) 2006-2015 Apple Inc. All rights reserved.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
 -->

<caldavtest ignore-all="no">
	<description>Test trash-collection support on the server</description>

	<require-feature>
		<feature>caldav</feature>
		<feature>trash-collection</feature>
        <feature>shared-calendars</feature>
	</require-feature>

	<start>
		<request>
			<method>POST</method>
			<ruri>$calendarhome1:/?action=emptytrash</ruri>
		</request>
        <request user="$userid2:" pswd="$pswd2:">
            <method>POST</method>
            <ruri>$calendarhome2:/?action=emptytrash</ruri>
        </request>
	</start>

	<test-suite name='Simple trashed event recovery'>
		<test name='1'>
			<description>PUT an event</description>
	        <request>
	            <method>MKCALENDAR</method>
	            <ruri>$calendarhome1:/tobedeleted/</ruri>
	        </request>
	        <request>
	            <method>PUT</method>
	            <ruri>$calendarhome1:/tobedeleted/1.ics</ruri>
	            <data>
	                <content-type>text/calendar; charset=utf-8</content-type>
	                <filepath>Resource/CalDAV/trash/1.txt</filepath>
	            </data>
	        </request>
	        <request>
	            <method>DELETE</method>
	            <ruri>$calendarhome1:/tobedeleted/1.ics</ruri>
	        </request>
	        <request>
	            <method>GET</method>
	            <ruri>$calendarhome1:/tobedeleted/1.ics</ruri>
                <verify>
			        <callback>statusCode</callback>
			        <arg>
			            <name>status</name>
			            <value>404</value>
			        </arg>
                </verify>
	        </request>
			<request>
				<method>POST</method>
				<ruri>$calendarhome1:/?action=recovertrash&amp;mode=event&amp;id=all</ruri>
			</request>
	        <request>
	            <method>GETNEW</method>
	            <ruri>$calendarhome1:/tobedeleted/</ruri>
                <verify>
                    <callback>calendarDataMatch</callback>
                    <arg>
                        <name>filepath</name>
                        <value>Resource/CalDAV/trash/1.txt</value>
                    </arg>
                </verify>
	        </request>
		</test>
        <test name='clean up'>
            <request>
                <method>DELETEALL</method>
                <ruri>$calendarhome1:/tobedeleted/</ruri>
            </request>
            <request>
                <method>DELETE</method>
                <ruri>$calendarhome1:/tobedeleted/</ruri>
            </request>
            <request>
                <method>POST</method>
                <ruri>$calendarhome1:/?action=emptytrash</ruri>
            </request>
        </test>
	</test-suite>


	<test-suite name='Trashed events do not show up in freebusy'>
		<test name='1'>
			<description>Create a calendar</description>
	        <request>
	            <method>MKCALENDAR</method>
	            <ruri>$calendarhome1:/tobedeleted/</ruri>
	        </request>
	    </test>
	    <test name='2'>
            <description>PUT timed event</description>
            <request>
                <method>PUT</method>
                <ruri>$calendarhome1:/tobedeleted/timed.ics</ruri>
                <data>
                    <content-type>text/calendar; charset=utf-8</content-type>
                    <filepath>Resource/CalDAV/trash/timed.ics</filepath>
                </data>
                <verify>
                    <callback>statusCode</callback>
                </verify>
            </request>
 	    </test>
 	    <test name='3'>
            <description>Freebusy matches timed event</description>
            <request print-response="yes">
                <method>POST</method>
                <ruri>$outboxpath1:/</ruri>
                <data>
                    <content-type>text/calendar; charset=utf-8</content-type>
                    <filepath>Resource/CalDAV/trash/fb.ics</filepath>
                </data>
                <verify>
                    <callback>postFreeBusy</callback>
                    <arg>
                        <name>attendee</name>
                        <value>$cuaddr1:</value>
                    </arg>
                    <arg>
                        <name>busy</name>
                        <value>$now.0:T130000Z/$now.0:T140000Z</value>
                    </arg>
                </verify>
            </request>
 	    </test>
	    <test name='4'>
            <description>PUT all-day event</description>
            <request>
                <method>PUT</method>
                <ruri>$calendarhome1:/tobedeleted/allday.ics</ruri>
                <data>
                    <content-type>text/calendar; charset=utf-8</content-type>
                    <filepath>Resource/CalDAV/trash/allday.ics</filepath>
                </data>
                <verify>
                    <callback>statusCode</callback>
                </verify>
            </request>
 	    </test>
	    <test name='5'>
            <description>Freebusy matches all-day event</description>
            <request print-response="yes">
                <method>POST</method>
                <ruri>$outboxpath1:/</ruri>
                <data>
                    <content-type>text/calendar; charset=utf-8</content-type>
                    <filepath>Resource/CalDAV/trash/fb.ics</filepath>
                </data>
                <verify>
                    <callback>postFreeBusy</callback>
                    <arg>
                        <name>attendee</name>
                        <value>$cuaddr1:</value>
                    </arg>
                    <arg>
                        <name>busy</name>
                        <value>$now.0:T000000Z/$now.1:T000000Z</value>
                    </arg>
                </verify>
            </request>
 	    </test>
	    <test name='6'>
            <description>Delete all-day event</description>
	        <request>
	            <method>DELETE</method>
	            <ruri>$calendarhome1:/tobedeleted/allday.ics</ruri>
	        </request>
 	    </test>
	    <test name='7'>
            <description>Freebusy matches timed event</description>
             <request print-response="yes">
                <method>POST</method>
                <ruri>$outboxpath1:/</ruri>
                <data>
                    <content-type>text/calendar; charset=utf-8</content-type>
                    <filepath>Resource/CalDAV/trash/fb.ics</filepath>
                </data>
                <verify>
                    <callback>postFreeBusy</callback>
                    <arg>
                        <name>attendee</name>
                        <value>$cuaddr1:</value>
                    </arg>
                    <arg>
                        <name>busy</name>
                        <value>$now.0:T130000Z/$now.0:T140000Z</value>
                    </arg>
                </verify>
            </request>
 	    </test>
	    <test name='8'>
            <description>Recover trashed all-day event</description>
			<request>
				<method>POST</method>
				<ruri>$calendarhome1:/?action=recovertrash&amp;mode=event&amp;id=all</ruri>
			</request>
 	    </test>
	    <test name='9'>
            <description>Freebusy matches all-day event once more</description>
             <request print-response="yes">
                <method>POST</method>
                <ruri>$outboxpath1:/</ruri>
                <data>
                    <content-type>text/calendar; charset=utf-8</content-type>
                    <filepath>Resource/CalDAV/trash/fb.ics</filepath>
                </data>
                <verify>
                    <callback>postFreeBusy</callback>
                    <arg>
                        <name>attendee</name>
                        <value>$cuaddr1:</value>
                    </arg>
                    <arg>
                        <name>busy</name>
                        <value>$now.0:T000000Z/$now.1:T000000Z</value>
                    </arg>
                </verify>
            </request>
  	    </test>
        <test name='clean up'>
            <request>
                <method>DELETEALL</method>
                <ruri>$calendarhome1:/tobedeleted/</ruri>
            </request>
            <request>
                <method>DELETE</method>
                <ruri>$calendarhome1:/tobedeleted/</ruri>
            </request>
            <request>
                <method>POST</method>
                <ruri>$calendarhome1:/?action=emptytrash</ruri>
            </request>
        </test>
	</test-suite>

    <test-suite name='Organizer trashes event'>
        <test name='1'>
            <description>Create a calendar</description>
            <request>
                <method>MKCALENDAR</method>
                <ruri>$calendarhome1:/tobedeleted/</ruri>
            </request>
        </test>
        <test name='2'>
            <description>PUT scheduled event</description>
            <request>
                <method>PUT</method>
                <ruri>$calendarhome1:/tobedeleted/1.ics</ruri>
                <data>
                    <content-type>text/calendar; charset=utf-8</content-type>
                    <filepath>Resource/CalDAV/trash/organizertrash/invite.ics</filepath>
                </data>
                <verify>
                    <callback>statusCode</callback>
                </verify>
            </request>
        </test>
        <test name='3'>
            <description>One item in user02 Inbox</description>
            <request user="$useradmin:" pswd="$pswdadmin:">
                <method>WAITDELETEALL 1</method>
                <ruri>$inboxpath2:/</ruri>
            </request>
        </test>
        <test name='4'>
            <description>Attendee replies with Tentative</description>
            <request user="$userid2:" pswd="$pswd2:">
                <method>GETNEW</method>
                <ruri>$calendarpath2:/</ruri>
                <verify>
                    <callback>statusCode</callback>
                </verify>
            </request>
            <request user="$userid2:" pswd="$pswd2:">
                <method>PUT</method>
                <ruri>$</ruri>
                <data>
                    <content-type>text/calendar; charset=utf-8</content-type>
                    <filepath>Resource/CalDAV/trash/organizertrash/reply.ics</filepath>
                </data>
                <verify>
                    <callback>statusCode</callback>
                </verify>
            </request>
        </test>
        <test name='5'>
            <description>One item in user01 Inbox</description>
            <request user="$useradmin:" pswd="$pswdadmin:">
                <method>WAITDELETEALL 1</method>
                <ruri>$inboxpath1:/</ruri>
            </request>
        </test>
        <test name='6'>
            <description>Organizer trashes event</description>
            <request>
                <method>DELETE</method>
                <ruri>$calendarhome1:/tobedeleted/1.ics</ruri>
            </request>
        </test>
        <test name='7'>
            <description>One item in user02 Inbox</description>
            <request user="$useradmin:" pswd="$pswdadmin:">
                <method>WAITDELETEALL 1</method>
                <ruri>$inboxpath2:/</ruri>
            </request>
        </test>
        <test name='8'>
            <description>Attendee sees cancellation</description>
            <request user="$userid2:" pswd="$pswd2:">
                <method>GETNEW</method>
                <ruri>$calendarpath2:/</ruri>
                <verify>
                    <callback>calendarDataMatch</callback>
                    <arg>
                        <name>filepath</name>
                        <value>Resource/CalDAV/trash/organizertrash/cancelled.ics</value>
                    </arg>
                </verify>
            </request>
        </test>
        <test name='9'>
            <description>Attendee deletes cancellation</description>
            <request user="$userid2:" pswd="$pswd2:">
                <method>DELETE</method>
                <ruri>$</ruri>
                <verify>
                    <callback>statusCode</callback>
                </verify>
            </request>
        </test>

        <test name='10'>
            <description>Recover trash</description>
            <request>
                <method>POST</method>
                <ruri>$calendarhome1:/?action=recovertrash&amp;mode=event&amp;id=all</ruri>
            </request>
        </test>
        <test name='11'>
            <description>One item in user02 Inbox</description>
            <request user="$useradmin:" pswd="$pswdadmin:">
                <method>WAITDELETEALL 1</method>
                <ruri>$inboxpath2:/</ruri>
            </request>
        </test>
        <test name='12'>
            <description>Attendee sees re-invite</description>
            <request user="$userid2:" pswd="$pswd2:">
                <method>GETNEW</method>
                <ruri>$calendarpath2:/</ruri>
                <verify>
                    <callback>calendarDataMatch</callback>
                    <arg>
                        <name>filepath</name>
                        <value>Resource/CalDAV/trash/organizertrash/recovered.ics</value>
                    </arg>
                </verify>
            </request>
        </test>
        <test name='clean up'>
            <request>
                <method>DELETEALL</method>
                <ruri>$calendarhome1:/tobedeleted/</ruri>
            </request>
            <request>
                <method>DELETE</method>
                <ruri>$calendarhome1:/tobedeleted/</ruri>
            </request>
            <request user="$userid2:" pswd="$pswd2:">
                <method>WAITDELETEALL 1</method>
                <ruri>$inboxpath2:/</ruri>
            </request>
            <request user="$userid2:" pswd="$pswd2:">
                <method>DELETEALL</method>
                <ruri>$calendarpath2:/</ruri>
            </request>
            <request>
                <method>POST</method>
                <ruri>$calendarhome1:/?action=emptytrash</ruri>
            </request>
            <request user="$userid2:" pswd="$pswd2:">
                <method>POST</method>
                <ruri>$calendarhome2:/?action=emptytrash</ruri>
            </request>
        </test>
    </test-suite>

    <test-suite name='Attendee trashes event'>
        <test name='1'>
            <description>Create a calendar</description>
            <request>
                <method>MKCALENDAR</method>
                <ruri>$calendarhome1:/tobedeleted/</ruri>
            </request>
        </test>
        <test name='2'>
            <description>PUT scheduled event</description>
            <request>
                <method>PUT</method>
                <ruri>$calendarhome1:/tobedeleted/1.ics</ruri>
                <data>
                    <content-type>text/calendar; charset=utf-8</content-type>
                    <filepath>Resource/CalDAV/trash/attendeetrash/invite.ics</filepath>
                </data>
                <verify>
                    <callback>statusCode</callback>
                </verify>
            </request>
        </test>
        <test name='3'>
            <description>One item in user02 Inbox</description>
            <request user="$useradmin:" pswd="$pswdadmin:">
                <method>WAITDELETEALL 1</method>
                <ruri>$inboxpath2:/</ruri>
            </request>
        </test>
        <test name='4'>
            <description>Attendee replies Tentative</description>
            <request user="$userid2:" pswd="$pswd2:">
                <method>GETNEW</method>
                <ruri>$calendarpath2:/</ruri>
                <verify>
                    <callback>statusCode</callback>
                </verify>
            </request>
            <request user="$userid2:" pswd="$pswd2:">
                <method>PUT</method>
                <ruri>$</ruri>
                <data>
                    <content-type>text/calendar; charset=utf-8</content-type>
                    <filepath>Resource/CalDAV/trash/attendeetrash/reply.ics</filepath>
                </data>
                <verify>
                    <callback>statusCode</callback>
                </verify>
            </request>
        </test>
        <test name='5'>
            <description>One item in user01 Inbox</description>
            <request user="$useradmin:" pswd="$pswdadmin:">
                <method>WAITDELETEALL 1</method>
                <ruri>$inboxpath1:/</ruri>
            </request>
        </test>
        <test name='6'>
            <description>Attendee trashes event</description>
            <request user="$userid2:" pswd="$pswd2:">
                <method>DELETE</method>
                <ruri>$</ruri>
            </request>
        </test>
        <test name='7'>
            <description>One item in user01 Inbox</description>
            <request user="$useradmin:" pswd="$pswdadmin:">
                <method>WAITDELETEALL 1</method>
                <ruri>$inboxpath1:/</ruri>
            </request>
        </test>
        <test name='8'>
            <description>Organizer sees declined</description>
            <request user="$useradmin:" pswd="$pswdadmin:">
                <method>GET</method>
                <ruri>$calendarhome1:/tobedeleted/1.ics</ruri>
                <verify>
                    <callback>calendarDataMatch</callback>
                    <arg>
                        <name>filepath</name>
                        <value>Resource/CalDAV/trash/attendeetrash/declined.ics</value>
                    </arg>
                </verify>
            </request>
        </test>
        <test name='9'>
            <description>Attendee recovers trash</description>
            <request>
                <method>POST</method>
                <ruri>$calendarhome2:/?action=recovertrash&amp;mode=event&amp;id=all</ruri>
            </request>
        </test>
        <test name='10'>
            <description>One item in user01 Inbox</description>
            <request user="$useradmin:" pswd="$pswdadmin:">
                <method>WAITDELETEALL 1</method>
                <ruri>$inboxpath1:/</ruri>
            </request>
        </test>
        <test name='11'>
            <description>Organizer sees tentative</description>
            <request user="$useradmin:" pswd="$pswdadmin:">
                <method>GET</method>
                <ruri>$calendarhome1:/tobedeleted/1.ics</ruri>
                <verify>
                    <callback>calendarDataMatch</callback>
                    <arg>
                        <name>filepath</name>
                        <value>Resource/CalDAV/trash/attendeetrash/recovered.ics</value>
                    </arg>
                </verify>
            </request>
        </test>
        <test name='clean up'>
            <request>
                <method>DELETEALL</method>
                <ruri>$calendarhome1:/tobedeleted/</ruri>
            </request>
            <request>
                <method>DELETE</method>
                <ruri>$calendarhome1:/tobedeleted/</ruri>
            </request>
            <request user="$userid2:" pswd="$pswd2:">
                <method>WAITDELETEALL 1</method>
                <ruri>$inboxpath2:/</ruri>
            </request>
            <request user="$userid2:" pswd="$pswd2:">
                <method>DELETEALL</method>
                <ruri>$calendarpath2:/</ruri>
            </request>
            <request>
                <method>POST</method>
                <ruri>$calendarhome1:/?action=emptytrash</ruri>
            </request>
            <request user="$userid2:" pswd="$pswd2:">
                <method>POST</method>
                <ruri>$calendarhome2:/?action=emptytrash</ruri>
            </request>
        </test>

    </test-suite>


    <test-suite name='Sharee trashes event'>

        <test name='Setup'>
            <request end-delete="yes">
                <method>MKCALENDAR</method>
                <ruri>$calendarhome1:/shared/</ruri>
            </request>
            <request>
                <method>POST</method>
                <ruri>$calendarhome1:/shared/</ruri>
                <data>
                    <content-type>text/xml; charset=utf-8</content-type>
                    <filepath>Resource/Common/POST/sharinginvite23.xml</filepath>
                </data>
                <verify>
                    <callback>statusCode</callback>
                </verify>
            </request>
            <request user="$userid2:" pswd="$pswd2:">
                <method>WAITCOUNT 1</method>
                <ruri>$notificationpath2:/</ruri>
            </request>
            <request user="$userid2:" pswd="$pswd2:">
                <method>GETNEW</method>
                <ruri>$notificationpath2:/</ruri>
                <grabelement>
                    <name>{http://calendarserver.org/ns/}invite-notification/{http://calendarserver.org/ns/}uid</name>
                    <variable>$inviteuid2:</variable>
                </grabelement>
                <grabelement>
                    <name>{http://calendarserver.org/ns/}invite-notification/{http://calendarserver.org/ns/}hosturl/{DAV:}href</name>
                    <variable>$hosturl2:</variable>
                </grabelement>
            </request>
            <request user="$userid2:" pswd="$pswd2:">
                <method>POST</method>
                <ruri>$calendarhome2:/</ruri>
                <data>
                    <content-type>application/xml; charset=utf-8</content-type>
                    <filepath>Resource/Common/POST/sharingreply2.xml</filepath>
                </data>
                <grabelement>
                    <name>{DAV:}href</name>
                    <variable>$sharedcalendar2:</variable>
                </grabelement>
            </request>
        </test>

        <test name='User01 adds event'>
            <description>User01 store to shared</description>
            <request user="$userid1:" pswd="$pswd1:">
                <method>PUT</method>
                <ruri>$calendarhome1:/shared/1.ics</ruri>
                <data>
                    <content-type>text/calendar; charset=utf-8</content-type>
                    <filepath>Resource/CalDAV/sharing/peruser-data/simple-put/1.ics</filepath>
                </data>
            </request>
        </test>

        <test name='User02 sees event'>
            <description>User02 sees event</description>
            <request user="$userid2:" pswd="$pswd2:">
                <method>GET</method>
                <ruri>$sharedcalendar2:/1.ics</ruri>
                <verify>
                    <callback>calendarDataMatch</callback>
                    <arg>
                        <name>filepath</name>
                        <value>Resource/CalDAV/sharing/peruser-data/simple-put/2.ics</value>
                    </arg>
                </verify>
            </request>
        </test>

        <test name='User02 trashes event'>
            <description>User02 trashes event</description>
            <request user="$userid2:" pswd="$pswd2:">
                <method>DELETE</method>
                <ruri>$sharedcalendar2:/1.ics</ruri>
                <verify>
                    <callback>statusCode</callback>
                </verify>
            </request>
        </test>

        <test name='User01 no longer sees event'>
            <description>User01 no longer sees event</description>
            <request user="$userid1:" pswd="$pswd1:">
                <method>GET</method>
                <ruri>$calendarhome1:/shared/1.ics</ruri>
                <verify>
                    <callback>statusCode</callback>
                    <arg>
                        <name>status</name>
                        <value>404</value>
                    </arg>
                </verify>
            </request>
        </test>

        <test name='User01 recovers trash'>
            <request>
                <method>POST</method>
                <ruri>$calendarhome1:/?action=recovertrash&amp;mode=event&amp;id=all</ruri>
            </request>
        </test>

        <test name='User01 sees event'>
            <request user="$userid1:" pswd="$pswd1:">
                <method>GETNEW</method>
                <ruri>$calendarhome1:/shared/</ruri>
                <verify>
                    <callback>calendarDataMatch</callback>
                    <arg>
                        <name>filepath</name>
                        <value>Resource/CalDAV/sharing/peruser-data/simple-put/1.ics</value>
                    </arg>
                </verify>
            </request>
        </test>

        <test name='User02 sees event'>
            <description>User02 sees event</description>
            <request user="$userid2:" pswd="$pswd2:">
                <method>GETNEW</method>
                <ruri>$sharedcalendar2:/</ruri>
                <verify>
                    <callback>calendarDataMatch</callback>
                    <arg>
                        <name>filepath</name>
                        <value>Resource/CalDAV/sharing/peruser-data/simple-put/2.ics</value>
                    </arg>
                </verify>
            </request>
        </test>

        <test name='clean up'>
            <request user="$useradmin:" pswd="$pswdadmin:">
                <method>DELETEALL</method>
                <ruri>$notificationpath1:/</ruri>
                <ruri>$notificationpath2:/</ruri>
            </request>
        </test>


    </test-suite>

    <end/>

</caldavtest>
